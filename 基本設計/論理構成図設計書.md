# Fanlogue 基本設計書 - 論理構成図設計書（フェーズ1 MVP版）

### 1. システム全体設計書

| 項目    | 内容       |
| ----- | -------- |
| 1.1   | システム構成図  |
| 1.1.1 | 論理構成図設計書 |

本設計書では、FanlogueサービスのMVP（Minimum Viable Product）フェーズ1における論理的なシステム構成と、各モジュール間の連携関係を定義します。

**目的**:

* システムの主要な機能ブロックとそれらの相互作用を明確にする。
* ビジネス要件を技術的なコンポーネントにマッピングし、開発チーム内での共通理解を促進する。
* 将来的な拡張性やWeb3連携を考慮した、柔軟なアーキテクチャの基盤を築く。

**対象範囲**:
「要件定義書.md」における「図3: Phase 1のシステムアーキテクチャ概要」をベースに、より詳細なモジュールとその連携を定義します。特に、ユーザーが直接利用するWebアプリケーション、バックエンドAPI、データベース、非同期処理の仕組みに焦点を当てます。

\`\`\`mermaid
graph TD
    subgraph Frontend
        PWA["Webアプリケーション - PWA"]
        AdminUI["運営管理画面"]
    end

    subgraph Gateway
        APIGW["API Gateway / Reverse Proxy"]
    end

    subgraph Backend
        Auth["認証・認可サービス"]
        UserSvc["ユーザーサービス"]
        ArtistSvc["アーティストサービス"]
        EventSvc["イベントサービス"]
        RewardSvc["報酬・ポイントサービス"]
        ContribSvc["貢献管理サービス"]
        NotificationSvc["通知サービス"]
    end

    subgraph Async
        MQ["メッセージキュー"]
        WP["ワーカープロセス"]
    end

    subgraph Storage
        S3["オブジェクトストレージ"]
        DB1["ユーザーDB"]
        DB2["アーティストDB"]
        DB3["イベントDB"]
        DB4["報酬DB"]
        DB5["貢献DB"]
    end

    subgraph Monitoring
        OBS["オブザーバビリティ（監視・ログ）"]
    end

    %% Connections
    PWA --> APIGW
    AdminUI --> APIGW
    APIGW --> Auth
    APIGW --> UserSvc
    APIGW --> ArtistSvc
    APIGW --> EventSvc
    APIGW --> RewardSvc
    APIGW --> ContribSvc
    APIGW --> NotificationSvc

    Auth --> DB1
    UserSvc --> DB1
    ArtistSvc --> DB2
    EventSvc --> DB3
    RewardSvc --> DB4
    ContribSvc --> DB5

    EventSvc --> MQ
    ContribSvc --> MQ
    WP --> RewardSvc
    WP --> NotificationSvc
    RewardSvc --> DB4

    EventSvc --> S3
    ArtistSvc --> S3
    UserSvc --> S3

    Auth --> OBS
    UserSvc --> OBS
    EventSvc --> OBS
    RewardSvc --> OBS
    MQ --> OBS
    WP --> OBS
\`\`\`


### 2. 各コンポーネントの説明

| コンポーネント | 説明 |
| -- | -- |
| Webアプリケーション (PWA)               | ユーザーが直接利用するフロントエンドアプリケーション。「要件定義書.md」のFR7.1.x (ユーザー管理), FR7.2.x (イベント管理), FR7.4.x (ユーザビリティ) に対応。PWA（Progressive Web App）として構築し、モバイルデバイスでの体験を最適化。バックエンドとの通信は全てAPI Gateway経由で行う。 |
| 運営管理画面                          | 運営管理者向けの専用インターフェース。「要件定義書.md」のFR7.6.x (管理機能) に対応。システムのマスターデータ（ユーザー、イベント、アーティスト、報酬など）のCRUD操作や、ユーザー貢献情報の審査などに利用。                                                                 |
| API Gateway / Reverse Proxy     | フロントエンドからの全てのリクエストを受け付ける単一のエントリーポイント。認証チェック、ルーティング、レートリミットなどの基本的な処理を行う。バックエンドのマイクロサービスへリクエストを転送。                                                                               |
| 認証・認可サービス (Auth Service)        | ユーザー登録 (FR7.1.1)、ログイン (FR7.1.2)、パスワード管理、JWT発行・検証などの認証・認可機能に特化。ユーザーDBと連携し、ユーザーの認証情報を管理。                                                                                         |
| ユーザーサービス (User Service)         | ユーザー情報（プロフィール、ポイント残高など）の管理、フォロー機能 (FR7.1.x) を提供。「要件定義書.md」のFR7.1.3 (プロフィール参照・更新), FR7.1.4 (フォロー管理) などに対応。                                                                      |
| アーティストサービス (Artist Service)     | アーティスト情報の管理、アーティスト一覧・詳細の提供 (FR7.2.x) を担当。「要件定義書.md」のFR7.2.1 (アーティスト検索・閲覧), FR7.2.2 (アーティストフォロー) などに対応。                                                                         |
| イベントサービス (Event Service)        | イベント情報の登録 (FR7.2.x, FR7.10.x)、検索、参照、参加記録 (FR7.2.x, FR7.7.x) を担当。「要件定義書.md」のFR7.2.3 (イベント検索・閲覧), FR7.2.4 (イベント参加記録), FR7.10.1 (ユーザーイベント情報登録) などに対応。                             |
| 報酬・ポイントサービス (Reward Service)    | ポイント付与 (FR7.8.1)、スタンプ付与 (FR7.9.1)、報酬履歴の管理 (FR7.8.2, FR7.9.2)。ユーザーの総獲得ポイントの更新、ポイント取引履歴、スタンプ獲得履歴を管理。メッセージキューを通じて非同期で処理を行う。                                                       |
| 貢献管理サービス (Contribution Service) | ユーザーからのイベント情報貢献 (FR7.10.x) の受け付け、管理、ステータス更新。将来的な審査プロセス（フェーズ2以降）にも対応可能な構造。貢献に対するポイント付与を報酬サービスに連携。                                                                               |
| データベース (Db1-Db5)                | 各サービスが自身のデータストアを持つマイクロサービス指向のアーキテクチャを想定。MVPではPostgreSQLを共有DBとして利用し、論理的にスキーマを分離する形も検討（物理構成図で詳細化）。                                                                               |
| オブジェクトストレージ (S3)                | イベント画像、アーティスト画像、ユーザープロフィール画像などの静的ファイルを保存。                                                                                                                                      |
| メッセージキュー (MQ)                   | システム内の非同期処理（例: ポイント付与、データ集計、通知など）を連携。サービスの疎結合化とスケーラビリティの向上に貢献 (NFR7.2.1, NFR7.2.2)。                                                                                            |
| ワーカープロセス (WP)                   | メッセージキューからタスクを受け取り、バックグラウンドで非同期処理を実行。報酬計算、ポイント集計、データ整合性維持などの重い処理をWebサーバーから分離。                                                                                                  |
| 通知サービス                          | メッセージキュー (通知用) を経由してユーザーへのリアルタイム通知（プッシュ通知など）をトリガー。FCM, APNs との連携を想定。                                                                                                           |
| オブザーバビリティ層 (Obs)                | システム全体の監視、ログ収集、トレーシングを行う。各サービスからのメトリクス、ログを一元的に収集・分析し、システムの健全性を可視化 (NFR7.5.1)。                                                                                                  |
| 外部システム (拡張予定)                   | チケットプラットフォームAPI、SNS連携API、位置情報サービスAPIなど、将来的な連携を想定。                                                                                                                              |

#### 3. データフロー例

1. **ユーザー登録**:

   * Webアプリケーション → API Gateway → 認証・認可サービス
   * 認証・認可サービス → ユーザーDB（データ書き込み）

2. **イベント情報閲覧**:

   * Webアプリケーション → API Gateway → イベントサービス
   * イベントサービス → イベントDB（データ読み込み）
   * イベントサービス → オブジェクトストレージ（画像URL取得）

3. **イベント参加記録**:

   * Webアプリケーション → API Gateway → イベントサービス
   * イベントサービス → イベントDB（データ書き込み）
   * イベントサービス → メッセージキュー（ポイント付与イベント発行）
   * メッセージキュー → ワーカープロセス
   * ワーカープロセス → 報酬・ポイントサービス → 報酬DB, ユーザーDB（ポイント更新）

この論理構成は、サービス間の疎結合性を高め、それぞれの機能を独立して開発・デプロイできるマイクロサービスアーキテクチャの基盤を形成します。MVPフェーズでは、一部サービスをモノリシックに実装し、将来的に分割していくアプローチも考慮されますが、論理的な分離を明確にすることが重要です。
