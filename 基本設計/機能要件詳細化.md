# 機能要件詳細化設計書

## 1. 概要  
本設計書は、アーティストイベント管理SaaSサービス「Fanlogue」の各機能要件について、具体的な処理ロジック、入力・出力データ、条件分岐などを詳細に定義するものである。これにより、「要件定義書.md」で定められた機能がシステム内でどのように実現されるかを明確にし、開発フェーズにおける認識の齟齬をなくすことを目的とする。

## 2. 一般的な設計原則  
- **API駆動開発:** 各機能は、先に定義されたAPI設計書（外部/内部）のインターフェースに基づいて実装される。  
- **モジュール間の連携:** 各機能は、モジュール/サブシステム分割定義設計書で定義された責任範囲に基づいて、適切なモジュールが担当し、必要に応じて他のモジュールとAPIを介して連携する。  
- **データ永続化:** データはデータベース設計書で定義されたテーブル構造に従って永続化される。  
- **エラーハンドリング:** 各処理ステップにおいて、予期されるエラー（入力バリデーションエラー、認証エラー、リソースNotFoundなど）に対する適切なエラーハンドリングと、共通エラーレスポンス形式に従った応答を行う。  
- **非同期処理の活用:** 時間のかかる処理や独立して実行可能な処理は、メッセージキュー（SQS）を利用した非同期処理として実装し、ユーザー体験を損なわないようにする。

## 3. 機能要件詳細

### 3.1. FR7.1.1 ユーザー登録

#### 概要  
新規ユーザーがFanlogueサービスにアカウントを登録する機能。メールアドレスとパスワード、またはソーシャルアカウント（Google, X, LINEなど）での登録をサポートする。

#### 処理ロジック  
- **入力受付:**  
  Webアプリケーションがユーザーからの登録情報（ユーザー名、メールアドレス、パスワード、またはソーシャルプロバイダ/ID）を受け付ける。

- **API呼び出し:**  
  Webアプリケーションは認証・認可モジュールが提供する `POST /auth/register` APIを呼び出す。

- **入力バリデーション:**  
  認証・認可モジュールは受信した入力データに対し、以下のバリデーションを行う。  
  - 必須項目の存在チェック（ユーザー名、メールアドレス、パスワードまたはソーシャルID）  
  - メールアドレスの形式チェック  
  - パスワードの強度ポリシーチェック（8文字以上、大文字小文字数字記号の組み合わせなど）  
  - メールアドレスのユニークネスチェック（usersテーブルを参照）  
  - ソーシャルIDのユニークネスチェック（usersテーブルを参照、ソーシャルプロバイダと組み合わせ）

- **Cognito連携:**  
  バリデーション成功後、認証・認可モジュールはAWS Cognito User Poolに対し、ユーザー登録リクエストを送信する。  
  - メールアドレスとパスワードの場合: Cognitoにユーザーを作成。  
  - ソーシャルアカウントの場合: Cognitoのフェデレーション機能を利用し、ソーシャルIDをCognitoユーザーにリンクまたは新規作成。

- **ユーザー情報保存:**  
  Cognitoでのユーザー作成/連携が完了した後、認証・認可モジュールは`users`テーブルにユーザーの基本情報（`user_id` (Cognitoのsubなど)、`username`、`email`、`social_provider`、`social_user_id`、`created_at`、`updated_at`、`current_points`を0で初期化）を保存する。

- **トークン発行:**  
  Cognitoから取得した認証トークン（アクセストークン、リフレッシュトークン）を生成または取得する。

- **レスポンス返却:**  
  認証・認可モジュールは、登録されたユーザー情報と認証トークンをWebアプリケーションに返却する。

#### 入力データ
| フィールド           | 型       | 必須 | 備考                          |
|----------------------|----------|------|-------------------------------|
| username             | 文字列   | 必須 |                               |
| email                | 文字列   | 必須 | メールアドレス形式           |
| password             | 文字列   | 必須 | パスワード登録時のみ         |
| social_provider      | 文字列   | 任意 | ソーシャルログイン時          |
| social_user_id       | 文字列   | 任意 | ソーシャルログイン時          |

#### 出力データ
| フィールド       | 型       | 備考         |
|------------------|----------|--------------|
| user_id          | UUID     | 生成されたID |
| username         | 文字列   |              |
| email            | 文字列   |              |
| access_token     | 文字列   | JWT形式      |
| refresh_token    | 文字列   | JWT形式      |

#### 条件分岐 / 特殊処理
- **バリデーションエラー:** 不正な入力があった場合、`400 Bad Request`とエラー詳細を返す。  
- **メールアドレス重複:** 既に登録済みの場合、`409 Conflict`を返す。  
- **ソーシャルID重複:** プロバイダと組み合わせたIDが既に存在する場合、`409 Conflict`を返す。  
- **Cognito連携エラー:** ユーザー作成に失敗した場合、適切なエラーを返す。

#### 関連情報
- 関連API: `POST /auth/register`  
- 関連モジュール: 認証・認可モジュール  
- 関連データストア: `users`テーブル  
- 利用する主要インフラ: AWS Cognito  

---

### 3.2. FR7.1.2 ログイン・ログアウト

#### 概要  
登録済みユーザーがサービスにログインし、セッションを終了するためにログアウトする機能。

---

#### 処理ロジック（ログイン）

- **入力受付:**  
  Webアプリケーションがユーザーからのログイン情報（メールアドレス、パスワード、またはソーシャルプロバイダ/ID）を受け付ける。

- **API呼び出し:**  
  Webアプリケーションは認証・認可モジュールが提供する `POST /auth/login` または `POST /auth/social/login` APIを呼び出す。

- **入力バリデーション:**  
  認証・認可モジュールは受信した入力データに対し、必須項目の存在チェック、メールアドレス形式チェックを行う。

- **Cognito連携:**  
  バリデーション成功後、認証・認可モジュールはAWS Cognito User Poolに対し、認証リクエストを送信する。  
  - メールアドレスとパスワードの場合: Cognitoで認証を試行。  
  - ソーシャルアカウントの場合: Cognitoのフェデレーション機能を利用し、ソーシャルプロバイダ経由で認証を試行。

- **ユーザー情報取得:**  
  認証成功後、usersテーブルからユーザーの最新プロフィール情報を取得する。

- **最終ログイン日時更新:**  
  usersテーブルの`last_login_at`を現在時刻で更新する。

- **トークン発行:**  
  Cognitoから取得した認証トークン（アクセストークン、リフレッシュトークン）を生成または取得する。

- **レスポンス返却:**  
  認証・認可モジュールは、認証されたユーザー情報と認証トークンをWebアプリケーションに返却する。

---

#### 処理ロジック（ログアウト）

- **入力受付:**  
  Webアプリケーションがユーザーからのログアウトリクエストを受け付ける。

- **API呼び出し:**  
  Webアプリケーションは認証・認可モジュールが提供する `POST /auth/logout` APIを呼び出す。  
  この際、ユーザーのアクセストークンをAuthorizationヘッダーに含める。

- **トークン検証:**  
  認証・認可モジュールは受信したアクセストークンの有効性を検証する。

- **Cognito連携:**  
  Cognitoからセッションを無効化する（トークンを失効させる）リクエストを送信する。

- **レスポンス返却:**  
  認証・認可モジュールは、ログアウト成功のレスポンスをWebアプリケーションに返却する。

---

#### 入力データ（ログイン）

| フィールド           | 型       | 必須 | 備考                    |
|----------------------|----------|------|-------------------------|
| email                | 文字列   | 必須 |                         |
| password             | 文字列   | 必須 | パスワードログイン時のみ |
| social_provider      | 文字列   | 任意 | ソーシャルログイン時     |
| social_user_id       | 文字列   | 任意 | ソーシャルログイン時     |

#### 出力データ（ログイン）

| フィールド       | 型       | 備考     |
|------------------|----------|----------|
| user_id          | UUID     |          |
| username         | 文字列   |          |
| email            | 文字列   |          |
| access_token     | 文字列   | JWT形式  |
| refresh_token    | 文字列   | JWT形式  |

---

#### 入力データ（ログアウト）

| フィールド             | 備考                     |
|------------------------|--------------------------|
| Authorizationヘッダー | アクセストークンを含める |

#### 出力データ（ログアウト）

| フィールド | 型       | 備考                        |
|------------|----------|-----------------------------|
| message    | 文字列   | 例: `"Logged out successfully"` |

---

#### 条件分岐 / 特殊処理

- **ログイン失敗:** 認証情報が無効な場合、`401 Unauthorized`を返す。  
- **トークン失効 / 不正:** ログアウト時にトークンが無効な場合、`401 Unauthorized`を返す。

#### 関連情報
- 関連API: `POST /auth/login`, `POST /auth/social/login`, `POST /auth/logout`  
- 関連モジュール: 認証・認可モジュール  
- 関連データストア: `users` テーブル  
- 利用する主要なインフラ: AWS Cognito  


### 3.3. FR7.1.3 プロフィール管理（閲覧・更新）

**概要**: 認証済みユーザーが自身のプロフィール情報（ユーザー名、メールアドレス、ポイント残高など）を閲覧し、一部の情報を更新する機能。

**処理ロジック (閲覧)**:  
- **入力受付**: Webアプリケーションがユーザーからのプロフィール閲覧リクエストを受け付ける。  
- **API呼び出し**: Webアプリケーションはユーザー管理モジュールが提供する `GET /users/me` APIを呼び出す。この際、ユーザーのアクセストークンをAuthorizationヘッダーに含める。  
- **認証・認可**: ユーザー管理モジュールは、認証・認可モジュールと連携し、受信したアクセストークンを検証し、リクエストユーザーが自身のプロフィールにアクセスする権限があるかを確認する。  
- **ユーザー情報取得**: 認可成功後、ユーザー管理モジュールはusersテーブルから該当ユーザーのプロフィール情報を取得する。  
- **レスポンス返却**: ユーザー管理モジュールは取得したプロフィール情報をWebアプリケーションに返却する。

**処理ロジック (更新)**:  
- **入力受付**: Webアプリケーションがユーザーからのプロフィール更新リクエスト（更新したい項目と値）を受け付ける。  
- **API呼び出し**: Webアプリケーションはユーザー管理モジュールが提供する `PUT /users/me` APIを呼び出す。この際、ユーザーのアクセストークンをAuthorizationヘッダーに含める。  
- **認証・認可**: ユーザー管理モジュールは、認証・認可モジュールと連携し、受信したアクセストークンを検証し、リクエストユーザーが自身のプロフィールを更新する権限があるかを確認する。  
- **入力バリデーション**: ユーザー管理モジュールは受信した更新データに対し、以下のバリデーションを行う。  
  - 更新可能な項目かどうかのチェック  
  - メールアドレスの形式チェック、およびユニークネスチェック（usersテーブルを参照）  
  - ユーザー名の長さや使用可能文字のチェック  
- **ユーザー情報更新**: バリデーション成功後、ユーザー管理モジュールはusersテーブルの該当ユーザーレコードを更新する。  
- **レスポンス返却**: ユーザー管理モジュールは更新されたプロフィール情報をWebアプリケーションに返却する。

**入力データ (閲覧)**:  
- Authorizationヘッダーにアクセストークン  

**出力データ (閲覧)**:  
- user_id, username, email, current_points, social_provider, social_user_id, created_at, updated_at, last_login_at  

**入力データ (更新)**:  
- Authorizationヘッダーにアクセストークン  
- ボディ: username (文字列), email (文字列) など、更新したい項目  

**出力データ (更新)**:  
- 更新後のユーザープロフィール情報（閲覧時と同じ形式）  

**条件分岐/特殊処理**:  
- 認証・認可エラー: トークンが無効、または権限がない場合、401 Unauthorizedまたは403 Forbiddenを返す。  
- バリデーションエラー: 不正な入力があった場合、400 Bad Requestとエラー詳細を返す。  
- メールアドレス重複: 更新しようとしたメールアドレスが既に他のユーザーによって使用されている場合、409 Conflictを返す。  

**関連API**:  
- GET /users/me  
- PUT /users/me  

**関連モジュール**:  
- ユーザー管理モジュール  
- 認証・認可モジュール  

**関連データストア**:  
- users テーブル  

---

### 3.4. FR7.1.4 アーティストフォロー・アンフォロー

**概要**: ユーザーが特定のアーティストをフォローしたり、フォローを解除したりする機能。

**処理ロジック (フォロー)**:  
- **入力受付**: Webアプリケーションがユーザーからのアーティストフォローリクエスト（アーティストID）を受け付ける。  
- **API呼び出し**: Webアプリケーションはアーティスト管理モジュールが提供する `POST /artists/{artist_id}/follow` APIを呼び出す。この際、ユーザーのアクセストークンをAuthorizationヘッダーに含める。  
- **認証・認可**: アーティスト管理モジュールは、認証・認可モジュールと連携し、アクセストークンを検証し、リクエストユーザーがフォローする権限があるかを確認する。  
- **アーティスト存在チェック**: artistsテーブルを参照し、指定されたartist_idのアーティストが存在するかを確認する。  
- **重複フォローチェック**: artist_followsテーブルを参照し、同じユーザーが同じアーティストを既にフォローしていないかを確認する。  
- **フォロー情報登録**: 重複がない場合、artist_followsテーブルに新しいフォローレコード（user_id, artist_id, followed_at）を登録する。  
- **レスポンス返却**: アーティスト管理モジュールはフォロー成功のレスポンスをWebアプリケーションに返却する。

**処理ロジック (アンフォロー)**:  
- **入力受付**: Webアプリケーションがユーザーからのアーティストアンフォローリクエスト（アーティストID）を受け付ける。  
- **API呼び出し**: Webアプリケーションはアーティスト管理モジュールが提供する `POST /artists/{artist_id}/unfollow` APIを呼び出す。この際、ユーザーのアクセストークンをAuthorizationヘッダーに含める。  
- **認証・認可**: アーティスト管理モジュールは、認証・認可モジュールと連携し、アクセストークンを検証し、リクエストユーザーがアンフォローする権限があるかを確認する。  
- **フォロー存在チェック**: artist_followsテーブルを参照し、指定されたユーザーとアーティストのフォロー関係が存在するかを確認する。  
- **フォロー情報削除**: フォロー関係が存在する場合、artist_followsテーブルから該当レコードを削除する。  
- **レスポンス返却**: アーティスト管理モジュールはアンフォロー成功のレスポンスをWebアプリケーションに返却する。

**入力データ (フォロー/アンフォロー)**:  
- パスパラメータ: artist_id (UUID)  
- Authorizationヘッダーにアクセストークン  

**出力データ (フォロー)**:  
- message: 文字列 ("アーティストをフォローしました。" など)  
- artist_follow_id: UUID (生成されたフォローID)  

**出力データ (アンフォロー)**:  
- message: 文字列 ("アーティストのフォローを解除しました。" など)  

**条件分岐/特殊処理**:  
- 認証・認可エラー: トークンが無効、または権限がない場合、401 Unauthorizedまたは403 Forbiddenを返す。  
- アーティストNotFound: 指定されたアーティストが存在しない場合、404 Not Foundを返す。  
- 重複フォロー: 既にフォローしているアーティストを再度フォローしようとした場合、409 Conflictを返す。  
- フォロー未存在: フォローしていないアーティストをアンフォローしようとした場合、404 Not Foundを返す。  

**関連API**:  
- POST /artists/{artist_id}/follow  
- POST /artists/{artist_id}/unfollow  

**関連モジュール**:  
- アーティスト管理モジュール  
- 認証・認可モジュール  

**関連データストア**:  
- artists テーブル  
- artist_follows テーブル  

### 3.5. FR7.1.5 イベント情報閲覧・検索

#### 概要
ユーザーがシステムに登録されているイベント情報を一覧で閲覧したり、キーワードやタグ、アーティストなどで絞り込んで検索したりする機能。

#### 処理ロジック

- **入力受付**  
  Webアプリケーションがユーザーからのイベント一覧/検索リクエスト（検索キーワード、ページ番号、表示件数、アーティストID、タグID、開催日時範囲、ステータスなど）を受け付ける。

- **API呼び出し**  
  Webアプリケーションはイベント管理モジュールが提供する `GET /events` APIを呼び出す。

- **入力バリデーション**  
  イベント管理モジュールは受信したクエリパラメータに対し、形式チェック（例: 日付形式）、数値範囲チェックなどを行う。

- **イベント情報検索**  
  `events` テーブルに対し、受信したクエリパラメータに基づいて以下の条件で検索を行う。
  
  - `search_query`: `event_name` または `description` に対する部分一致検索
  - `artist_id`: 完全一致フィルタリング
  - `tag_id`: `event_tag_relations` テーブルと `event_tags` テーブルを結合し、`tag_id` によるフィルタリング
  - `start_date_from/start_date_to`: `start_datetime` カラムによる範囲検索
  - `status`: `status` カラムによるフィルタリング
  - ページネーション: `page`, `limit` を適用

- **関連情報取得**  
  関連するアーティスト名（`artists` テーブル）やタグ名（`event_tags` テーブル）を付与

- **レスポンス返却**  
  イベント管理モジュールは検索結果（イベントリスト、総件数、現在のページ、リミット）をWebアプリケーションに返却

#### 入力データ（クエリパラメータ）

- `page`, `limit`, `search_query`, `artist_id`, `tag_id`, `start_date_from`, `start_date_to`, `status`

#### 出力データ

- `total_count`: 整数（検索結果の総件数）  
- `page`: 整数（現在のページ番号）  
- `limit`: 整数（1ページあたりの件数）  
- `events`: イベントオブジェクト配列（各オブジェクトは以下を含む）:

  - `event_id`: UUID  
  - `artist_id`: UUID  
  - `event_name`: 文字列  
  - `description`: 文字列  
  - `start_datetime`: ISO 8601形式タイムスタンプ  
  - `end_datetime`: ISO 8601形式タイムスタンプ  
  - `location`: 文字列  
  - `ticket_url`: 文字列（URL）  
  - `event_image_url`: 文字列（URL）  
  - `status`: 文字列  
  - `tags`: 文字列の配列（関連タグ名）

#### 条件分岐・特殊処理

- バリデーションエラー：400 Bad Request
- 結果なし：空の `events` 配列と `total_count: 0`

#### 関連情報

- 関連API：`GET /events`
- 関連モジュール：イベント管理モジュール、アーティスト管理モジュール
- 関連データストア：`events`, `artists`, `event_tags`, `event_tag_relations`

---

### 3.6. FR7.1.6 イベント参加記録

#### 概要
ユーザーがイベントに参加したことをシステムに記録する機能。参加方法（手動入力、QRスキャン、チケット連携）に応じて、検証プロセスが異なる。参加記録が成功すると、報酬が付与される可能性がある。

#### 処理ロジック

- **入力受付**  
  Webアプリケーションがユーザーからのイベント参加記録リクエスト（イベントID、参加方法、検証データ、メモ）を受け付ける。

- **API呼び出し**  
  Webアプリケーションは `POST /events/{event_id}/attend` API を呼び出す。アクセストークンを Authorization ヘッダーに含める。

- **認証・認可**  
  認証・認可モジュールと連携し、アクセストークンを検証、リクエストユーザーが記録を行う権限を確認。

- **イベント存在チェック**  
  `events` テーブルで指定された `event_id` のイベントが存在するか、ステータスが `active` または `completed` であるかを確認。

- **重複参加チェック**  
  `event_attendances` テーブルを参照し、同一ユーザーがすでに参加していないか確認。

- **参加方法に応じた検証**

  - `manual`: ユーザー自身が参加申告、`verification_status` は `pending`。運営者による後日承認が必要。
  - `qr_scan`: QRコードをスキャンし送信。`verification_data` が有効なQRコードであるか検証、成功時は `verified`。
  - `ticket_link`: 外部チケットプラットフォームと連携。チケットIDを用いて有効性を確認、成功時は `verified`。

- **イベント参加記録保存**  
  検証成功時、`event_attendances` テーブルに記録を保存。

- **報酬付与トリガー**  
  `verification_status` が `verified` の場合、報酬・ポイントシステムにメッセージキュー（SQS）で非同期に通知。

- **レスポンス返却**  
  成功レスポンスと報酬情報（ある場合）を返却。

#### 入力データ

- パスパラメータ: `event_id` (UUID)  
- Authorizationヘッダー: アクセストークン  
- ボディ:
  - `attendance_method`: 文字列 (`manual`, `qr_scan`, `ticket_link`)  
  - `verification_data`: 文字列（任意）  
  - `notes`: 文字列（任意）

#### 出力データ

- `event_attendance_id`: UUID  
- `user_id`: UUID  
- `event_id`: UUID  
- `attendance_timestamp`: タイムスタンプ  
- `attendance_method`: 文字列  
- `verification_status`: 文字列  
- `notes`: 文字列  
- `awarded_rewards`: 報酬オブジェクト配列（報酬があれば）

  各報酬オブジェクト:
  - `reward_id`: UUID  
  - `reward_type`: `stamp` または `point`  
  - `reward_name`: 文字列  
  - `value`: 整数  
  - `stamp_id`: UUID（スタンプのみ）  
  - `stamp_image_url`: 文字列（スタンプのみ）  
  - `point_history_id`: UUID（ポイントのみ）  
  - `current_points_after_change`: 整数（ポイントのみ）

#### 条件分岐・特殊処理

- 認証・認可エラー：401 Unauthorized / 403 Forbidden  
- イベントNotFound：404 Not Found  
- イベントステータス不適切：400 Bad Request  
- 重複参加：409 Conflict  
- 検証失敗（QRコードやチケット）：403 Forbidden

#### 関連情報

- 関連API：`POST /events/{event_id}/attend`
- 関連モジュール：イベント管理モジュール、認証・認可モジュール、報酬・ポイントシステムモジュール、外部連携モジュール（チケット連携時）
- 関連データストア：`events`, `event_attendances`, `rewards`, `stamps`, `point_histories`, `users`
- インフラ：AWS SQS（非同期報酬付与トリガー）

### 3.7. FR7.1.7 報酬（スタンプ・ポイント）獲得・履歴閲覧  
**概要**: ユーザーが獲得したスタンプやポイントの履歴を閲覧し、現在のポイント残高を確認する機能。

##### 処理ロジック (スタンプ閲覧)
| ステップ | 内容 |
|---------|------|
| 入力受付 | Webアプリケーションがユーザーからのスタンプ一覧閲覧リクエストを受け付ける。 |
| API呼び出し | Webアプリケーションは報酬・ポイントシステムモジュールが提供する `GET /users/me/stamps` APIを呼び出す。この際、ユーザーのアクセストークンをAuthorizationヘッダーに含める。 |
| 認証・認可 | アクセストークンを検証し、ユーザーが自身のスタンプにアクセス可能か確認する。 |
| スタンプ情報取得 | `stamps`テーブルをuser_idでフィルタリングし、必要に応じて`rewards`, `events`, `artists`を結合して情報取得。 |
| レスポンス返却 | スタンプ一覧をWebアプリケーションに返却。 |

##### 処理ロジック (ポイント履歴閲覧)
| ステップ | 内容 |
|---------|------|
| 入力受付 | Webアプリケーションがユーザーからのポイント履歴閲覧リクエストを受け付ける。 |
| API呼び出し | `GET /users/me/point-histories` を呼び出す。アクセストークンをAuthorizationヘッダーに含める。 |
| 認証・認可 | アクセストークンを検証し、ユーザーが自身のポイント履歴にアクセス可能か確認。 |
| ポイント履歴取得 | `point_histories`テーブルをuser_idでフィルタリング、必要に応じて関連テーブル結合。 |
| 現在のポイント残高取得 | `users`テーブルの`current_points`を取得。 |
| レスポンス返却 | ポイント履歴とポイント残高を返却。 |

##### 入力データ
- Authorizationヘッダー: アクセストークン
- クエリパラメータ: `page`, `limit`

##### 出力データ
**スタンプ閲覧**:
- `total_count`: 整数
- `page`: 整数
- `limit`: 整数
- `stamps`: スタンプオブジェクト配列

**ポイント履歴閲覧**:
- `total_count`: 整数
- `page`: 整数
- `limit`: 整数
- `current_points`: 整数
- `point_histories`: ポイント履歴オブジェクト配列

##### 条件分岐/特殊処理
- トークン無効/権限なし: `401 Unauthorized`, `403 Forbidden`
- 結果なし: 空配列 + `total_count: 0`

##### 関連API
- `GET /users/me/stamps`
- `GET /users/me/point-histories`

##### 関連モジュール
- 報酬・ポイントシステムモジュール
- ユーザー管理モジュール
- 認証・認可モジュール

##### 関連データストア
- `stamps`
- `point_histories`
- `users`
- `rewards`
- `events`
- `artists`

---

### 3.8. FR7.1.8 運営者によるアーティスト・イベント管理  
**概要**: 運営者がアーティスト情報やイベント情報の登録、更新、削除を行う機能。

##### アーティスト登録
| ステップ | 内容 |
|---------|------|
| 入力受付 | 運営管理画面がアーティスト登録情報を受け付ける。 |
| API呼び出し | `POST /artists`。Authorizationヘッダーにアクセストークン。 |
| 認証・認可 | 運営者ロールかを確認。 |
| 入力バリデーション | 必須項目、ユニークチェック等。 |
| アーティスト情報保存 | `artists`テーブルに登録、画像はS3にアップロードしてURL保存。 |
| レスポンス返却 | 登録済みアーティスト情報を返却。 |

##### アーティスト更新
| ステップ | 内容 |
|---------|------|
| 入力受付 | アーティストIDと更新データを受け取る。 |
| API呼び出し | `PUT /artists/{artist_id}` |
| 認証・認可 | 運営者ロールを確認。 |
| 存在チェック・バリデーション | `artists`テーブル確認とデータ検証。 |
| 更新処理 | 該当レコード更新。画像がある場合はS3も更新。 |
| レスポンス返却 | 更新後データ返却。 |

##### アーティスト削除
| ステップ | 内容 |
|---------|------|
| 入力受付 | 削除対象の`artist_id`を受け取る。 |
| API呼び出し | `DELETE /artists/{artist_id}` |
| 認証・認可 | 運営者ロールを確認。 |
| 関連データ削除 | `events`, `follows`, `rewards`等も削除/無効化。 |
| 削除処理 | `artists`テーブルの該当レコードを削除。 |
| レスポンス返却 | 成功レスポンスを返却。 |

##### イベント登録・更新・削除
- イベント管理モジュールでアーティストと同様のロジック。
- API: `POST /events`, `PUT /events/{event_id}`, `DELETE /events/{event_id}`
- 登録時: アーティスト存在チェック。
- 削除時: 関連データも処理。

##### 条件分岐/特殊処理
- 権限なし: `403 Forbidden`
- リソース未発見: `404 Not Found`
- 重複: `409 Conflict`
- 入力エラー: `400 Bad Request`

##### 関連API
- アーティスト: `POST /artists`, `PUT /artists/{artist_id}`, `DELETE /artists/{artist_id}`
- イベント: `POST /events`, `PUT /events/{event_id}`, `DELETE /events/{event_id}`

##### 関連モジュール
- 運営管理モジュール
- アーティスト管理モジュール
- イベント管理モジュール
- 認証・認可モジュール

##### 関連データストア
- `artists`
- `events`
- `artist_follows`
- `event_attendances`
- `rewards`
- `stamps`
- `point_histories`
- AWS S3

---

### 3.9. FR7.1.9 外部システム連携（チケットプラットフォーム）  
**概要**: 外部のチケット販売プラットフォームと連携し、イベント参加記録に反映。

##### 処理ロジック
| ステップ | 内容 |
|---------|------|
| コールバック受信 | `GET/POST /integrations/ticket-platform/callback` で受信。 |
| 認証・検証 | 共有シークレットや署名で認証。 |
| データ解析 | ペイロードを解析。 |
| イベント・ユーザー特定 | 外部IDに基づいて`events`, `users`を検索。 |
| 参加記録処理 | 購入: 補助情報として記録。参加確認: `POST /events/{event_id}/attend`でverifiedとして登録。 |
| レスポンス返却 | 成功レスポンスを返却。 |

##### 入力データ
- Webhookペイロード（仕様参照）

##### 出力データ
- `message`: "Callback received successfully." 等

##### 条件分岐/特殊処理
- 認証失敗: `401 Unauthorized`
- ペイロード不正: `400 Bad Request`
- イベント/ユーザー未発見: ログに記録、`200 OK`で返す
- 冪等性対応: 重複処理なし

##### 関連API
- `GET/POST /integrations/ticket-platform/callback`
- `POST /events/{event_id}/attend`

##### 関連モジュール
- 外部連携モジュール
- イベント管理モジュール

##### 関連データストア
- `events`
- `users`
- `event_attendances`

---

### 3.10. FR7.1.10 外部システム連携（SNS）  
**概要**: SNSのWebhook通知を受け取り、システム内の情報更新や通知に活用。

##### 処理ロジック
| ステップ | 内容 |
|---------|------|
| Webhook受信 | `POST /integrations/sns/webhook` でSNS通知を受信。 |
| 認証・検証 | Webhook Secret、署名で認証。 |
| データ解析 | 投稿者ID、内容、タイムスタンプを解析。 |
| アーティスト特定 | `artists`テーブルから該当アーティストを特定。 |
| 情報更新/通知 | イベントキーワードがある投稿: 通知/イベント更新をトリガー。 |
| レスポンス返却 | SNS側に成功レスポンスを返却。 |

##### 入力データ
- SNSからのWebhookペイロード

##### 出力データ
- `message`: "Webhook received successfully." など

##### 条件分岐/特殊処理
- 認証失敗: `401 Unauthorized`
- 不正ペイロード: `400 Bad Request`
- アーティスト未発見: ログ記録、`200 OK`で返す

##### 関連API
- `POST /integrations/sns/webhook`

##### 関連モジュール
- 外部連携モジュール
- イベント管理モジュール
- 通知モジュール
- アーティスト管理モジュール

##### 関連データストア
- `artists`
- `events`（イベント更新が必要な場合）
