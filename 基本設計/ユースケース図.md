# ユースケース図/記述設計書
## 1. 概要  
本設計書は、アーティストイベント管理SaaSサービス「Fanlogue」における主要なユースケースを定義し、各ユースケースのアクター（ユーザー、運営者など）とシステムの相互作用を明確にすることを目的とする。これにより、システムの機能範囲と振る舞いを理解し、開発チーム内での共通認識を形成する。

## 2. 主要アクター  
- 一般ユーザー: Fanlogueサービスを利用する一般的なユーザー。アーティストをフォローし、イベント情報を閲覧・参加記録し、報酬を獲得する。  
- 運営者: Fanlogueサービスの管理者。アーティストやイベント情報の登録・管理など、システム運営に関わる操作を行う。  
- 外部チケットプラットフォーム: 外部のチケット販売システム。イベント情報や参加記録の連携を行う。  
- SNSプラットフォーム: X(旧Twitter)やLINEなどのソーシャルネットワーキングサービス。情報連携や通知を行う。

## 3. 主要ユースケース定義  
### 3.1. ユースケース: ユーザー登録  
- ユースケースID: UC-AUTH-001  
- ユースケース名: ユーザー登録  
- 概要: 新規ユーザーがFanlogueサービスにアカウントを登録する。メールアドレスとパスワード、またはソーシャルアカウントでの登録をサポートする。  
- アクター: 一般ユーザー  
- 事前条件:  
  - ユーザーがFanlogueのWebアプリケーションにアクセスしている。  
  - ユーザーが未登録である。  
- 事後条件:  
  - ユーザーアカウントがシステムに登録される。  
  - ユーザーはログイン状態となり、認証トークンが発行される。  
  - usersテーブルにユーザー情報が追加される。  
- 基本フロー:  
  1. 一般ユーザーはWebアプリケーションの登録画面にアクセスする。  
  2. 一般ユーザーは登録情報（ユーザー名、メールアドレス、パスワード、またはソーシャルアカウント情報）を入力し、登録ボタンをクリックする。  
  3. システムは入力された情報を検証する（形式、必須項目、ユニークネス）。  
  4. システムはAWS Cognito User Poolにユーザー登録リクエストを送信する。  
  5. Cognitoでのユーザー作成/連携が成功する。  
  6. システムはusersテーブルにユーザーの基本情報を保存する。  
  7. システムは認証トークン（アクセストークン、リフレッシュトークン）を発行する。  
  8. システムは登録成功のメッセージと認証トークンを一般ユーザーに返す。  
  9. 一般ユーザーはログイン後の画面に遷移する。  
- 代替フロー/例外:  
  - A1: 入力バリデーションエラー  
  - A2: メールアドレス/ソーシャルID重複  
  - A3: Cognito連携エラー  
- 関連API: `POST /auth/register`  
- 関連モジュール: 認証・認可モジュール  
- 関連データストア: users テーブル  
- ユースケース図:  
\`\`\`mermaid
sequenceDiagram
    actor User as 一般ユーザー
    participant WebApp as Webアプリケーション
    participant APIGW as API Gateway
    participant AuthSvc as 認証・認可モジュール
    participant Cognito as AWS Cognito
    participant UsersDB as users テーブル

    User->>WebApp: 登録画面アクセス
    User->>WebApp: 登録情報入力 & 登録
    WebApp->>APIGW: POST /auth/register リクエスト
    APIGW->>AuthSvc: 認証・認可リクエスト
    AuthSvc->>AuthSvc: 入力バリデーション
    AuthSvc->>Cognito: ユーザー登録/連携リクエスト
    Cognito-->>AuthSvc: ユーザー登録/連携成功
    AuthSvc->>UsersDB: ユーザー情報保存
    UsersDB-->>AuthSvc: 保存完了
    AuthSvc->>AuthSvc: 認証トークン発行
    AuthSvc-->>APIGW: 登録成功 & トークン応答
    APIGW-->>WebApp: 登録成功 & トークン応答
    WebApp->>User: 登録成功 & ログイン後画面表示
\`\`\`

---

### 3.2. ユースケース: ログイン・ログアウト  
- ユースケースID: UC-AUTH-002  
- ユースケース名: ログイン・ログアウト  
- 概要: 登録済みユーザーがサービスにログインし、セッションを終了するためにログアウトする。  
- アクター: 一般ユーザー  
- 事前条件:  
  - ログイン: ユーザーがFanlogueのWebアプリケーションにアクセスしている。  
  - ログアウト: ユーザーがログイン状態である。  
- 事後条件:  
  - ログイン: 認証成功、トークン発行、最終ログイン日時更新。  
  - ログアウト: トークン無効化。  
- 基本フロー (ログイン):  
  1. ログイン画面アクセス  
  2. ログイン情報入力 & ログイン  
  3. POST /auth/login リクエスト送信  
  4. 認証・バリデーション・Cognito認証  
  5. ユーザー情報取得 & 更新  
  6. トークン発行 & 応答  
  7. ログイン成功画面表示  
- 基本フロー (ログアウト):  
  1. ログアウト選択  
  2. トークン付きリクエスト送信  
  3. トークン検証 & 無効化  
  4. ログアウト完了 & トップ画面遷移  
- 代替フロー/例外:  
  - A1: 認証情報無効  
  - A2: トークン無効/期限切れ  
- 関連API: `POST /auth/login`, `POST /auth/social/login`, `POST /auth/logout`  
- 関連モジュール: 認証・認可モジュール  
- 関連データストア: users テーブル  
- ユースケース図:  
\`\`\`mermaid
sequenceDiagram
    actor User as 一般ユーザー
    participant WebApp as Webアプリケーション
    participant APIGW as API Gateway
    participant AuthSvc as 認証・認可モジュール
    participant Cognito as AWS Cognito
    participant UsersDB as users テーブル

    User->>WebApp: ログイン画面アクセス
    User->>WebApp: ログイン情報入力 & ログイン
    WebApp->>APIGW: POST /auth/login リクエスト
    APIGW->>AuthSvc: 認証リクエスト
    AuthSvc->>AuthSvc: 入力バリデーション
    AuthSvc->>Cognito: 認証リクエスト
    Cognito-->>AuthSvc: 認証成功
    AuthSvc->>UsersDB: ユーザー情報取得 & 最終ログイン日時更新
    UsersDB-->>AuthSvc: 更新完了 & 情報応答
    AuthSvc->>AuthSvc: 認証トークン発行
    AuthSvc-->>APIGW: 認証成功 & トークン応答
    APIGW-->>WebApp: 認証成功 & トークン応答
    WebApp->>User: ログイン成功 & ログイン後画面表示

    alt ログアウト
        User->>WebApp: ログアウトを選択
        WebApp->>APIGW: POST /auth/logout リクエスト (with access_token)
        APIGW->>AuthSvc: ログアウトリクエスト
        AuthSvc->>AuthSvc: トークン検証
        AuthSvc->>Cognito: セッション無効化リクエスト
        Cognito-->>AuthSvc: 無効化完了
        AuthSvc-->>APIGW: ログアウト成功応答
        APIGW-->>WebApp: ログアウト成功応答
        WebApp->>User: ログアウト完了 & ログイン画面遷移
    end

\`\`\`

---

### 3.3. ユースケース: プロフィール管理（閲覧・更新）  
- ユースケースID: UC-USER-001  
- ユースケース名: プロフィール管理（閲覧・更新）  
- 概要: 認証済みユーザーが自身のプロフィール情報（ユーザー名、メールアドレス、ポイント残高など）を閲覧し、一部の情報を更新する。  
- アクター: 一般ユーザー  
- 事前条件: ログイン状態である  
- 事後条件: 閲覧・更新が反映される  
- 基本フロー (閲覧):  
  1. プロフィール画面アクセス  
  2. `GET /users/me` リクエスト送信  
  3. トークン検証、プロフィール取得・表示  
- 基本フロー (更新):  
  1. 更新情報入力  
  2. `PUT /users/me` リクエスト送信  
  3. トークン検証・バリデーション  
  4. usersテーブル更新、成功メッセージ表示  
- 代替フロー/例外:  
  - A1: 認可エラー  
  - A2: バリデーションエラー  
  - A3: メールアドレス重複  
- 関連API: `GET /users/me`, `PUT /users/me`  
- 関連モジュール: ユーザー管理モジュール、認証・認可モジュール  
- 関連データストア: users テーブル  
- ユースケース図:  
\`\`\`mermaid
sequenceDiagram
    actor User as 一般ユーザー
    participant WebApp as Webアプリケーション
    participant APIGW as API Gateway
    participant UserMgtSvc as ユーザー管理モジュール
    participant AuthSvc as 認証・認可モジュール
    participant UsersDB as users テーブル

    User->>WebApp: プロフィール画面アクセス
    WebApp->>APIGW: GET /users/me リクエスト (with access_token)
    APIGW->>UserMgtSvc: プロフィール取得リクエスト
    UserMgtSvc->>AuthSvc: トークン検証 & 認可確認
    AuthSvc-->>UserMgtSvc: 認可成功
    UserMgtSvc->>UsersDB: ユーザー情報取得
    UsersDB-->>UserMgtSvc: ユーザー情報応答
    UserMgtSvc-->>APIGW: プロフィール情報応答
    APIGW-->>WebApp: プロフィール情報応答
    WebApp->>User: プロフィール情報表示

    alt プロフィール更新
        User->>WebApp: プロフィール更新情報入力 & 保存
        WebApp->>APIGW: PUT /users/me リクエスト (更新データ & access_token)
        APIGW->>UserMgtSvc: プロフィール更新リクエスト
        UserMgtSvc->>AuthSvc: トークン検証 & 認可確認
        AuthSvc-->>UserMgtSvc: 認可成功
        UserMgtSvc->>UserMgtSvc: 入力バリデーション
        UserMgtSvc->>UsersDB: ユーザー情報更新
        UsersDB-->>UserMgtSvc: 更新完了
        UserMgtSvc-->>APIGW: 更新済みプロフィール情報応答
        APIGW-->>WebApp: 更新済みプロフィール情報応答
        WebApp->>User: 更新成功メッセージ & プロフィール情報表示
    end
\`\`\`
---
