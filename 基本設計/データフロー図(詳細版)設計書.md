# データフロー図(詳細版)

## 1. 概要

本設計書は、アーティストイベント管理SaaSサービス「Fanlogue」における主要な機能におけるデータフローを詳細に定義するものである。『要件定義書.md』の「5.2.3 データフロー概要」および『論理構成図設計書.md』の「3. データフロー例」を拡張し、ユーザー操作、システムコンポーネント、データベース間のデータの流れと処理内容を具体的に示す。

## 2. 表記について

本設計書では、データフローを分かりやすく表現するため、以下の記号と表記を使用する。

| 種別                         | 説明                                 |
| -------------------------- | ---------------------------------- |
| プロセス (Process)             | データが変換される、または処理が行われる場所（例：API、サービス） |
| データストア (Data Store)        | データが保存される場所（例：データベース、オブジェクトストレージ）  |
| 外部エンティティ (External Entity) | システムの外部に存在するエンティティ（例：ユーザー、外部API）   |
| データフロー (Data Flow)         | データの移動方向を示す矢印                      |

## 3. 主要なデータフロー

### 3.1. ユーザー登録・ログインフロー

新規ユーザーがサービスに登録し、ログインするまでのデータフロー。

\`\`\`mermaid
graph TD
    A[ユーザー] -->|1. 登録情報入力| B
    B[Webアプリケーション] -->|2. 登録リクエスト| C
    C[API Gateway] -->|3. 認証・認可リクエスト| D
    D[認証・認可サービス] -->|4. ユーザー情報登録/検証| E
    E[users テーブル] -->|5. 登録完了/認証トークン発行| D
    D -->|6. 認証トークン応答| C
    C -->|7. 認証トークン応答| B
    B -->|8. ログイン成功/トップページ表示| A

    A -->|9. ログイン情報入力| B
    B -->|10. ログインリクエスト| C
    C -->|11. 認証リクエスト| D
    D -->|12. ユーザー情報検証| E
    E -->|13. ログイン情報検証結果/認証トークン発行| D
    D -->|14. 認証トークン応答| C
    C -->|15. 認証トークン応答| B
    B -->|16. ログイン成功/トップページ表示| A

\`\`\`

**処理内容**:

* Webアプリケーションから登録情報入力、API Gateway経由で認証・認可サービスへリクエスト。
* usersテーブルへ登録/検証後、認証トークンを発行。

**データストア**:

* usersテーブル（user\_id, username, email, password\_hash, social\_provider, social\_user\_id, created\_at, updated\_at, last\_login\_at）

### 3.2. アーティスト情報取得・フォローフロー
データフロー図
\`\`\`mermaid
graph TD
    A[ユーザー] -->|"1. アーティスト一覧/詳細閲覧リクエスト"| B[Webアプリケーション]
    B -->|"2. APIリクエスト"| C[API Gateway]
    C -->|"3. アーティスト情報取得リクエスト"| D[アーティストサービス]
    D -->|"4. アーティスト情報検索"| E[artists テーブル]
    E -->|"5. 検索結果応答"| D
    D -->|"6. アーティスト情報応答"| C
    C -->|"7. アーティスト情報応答"| B
    B -->|"8. アーティスト情報表示"| A

    A -->|"9. フォローボタンクリック"| B
    B -->|"10. フォローリクエスト"| C
    C -->|"11. アーティストフォローリクエスト"| D
    D -->|"12. フォロー情報登録"| F[artist_follows テーブル]
    F -->|"13. 登録結果応答"| D
    D -->|"14. フォロー成功応答"| C
    C -->|"15. フォロー成功応答"| B
    B -->|"16. フォロー状態更新"| A

\`\`\`
* 処理内容
  * ユーザーはWebアプリケーションからアーティスト一覧や詳細情報をリクエストします。API Gateway経由でアーティストサービスにリクエストが渡り、artistsテーブルから情報を取得してユーザーに返却します。
  * ユーザーが「フォロー」ボタンをクリックすると、アーティストサービスはartist_followsテーブルにユーザーとアーティストのフォロー関係を登録します。
データストア定義
| テーブル名 | 項目名 |
| -- | -- |
| `artists`        | artist\_id, artist\_name, description, official\_website\_url, sns\_links, profile\_image\_url, created\_at, updated\_at |
| `artist_follows` | artist\_follow\_id, user\_id, artist\_id, followed\_at                                                                   |

### 3.3. イベント情報登録・更新フロー（運営管理画面／アーティスト）
データフロー図
\`\`\`mermaid
graph TD
    A[運営者/アーティスト] -->|"1. イベント情報入力"| B[運営管理画面]
    B -->|"2. イベント登録/更新リクエスト"| C[API Gateway]
    C -->|"3. イベント登録/更新処理リクエスト"| D[イベントサービス]
    D -->|"4. イベント情報保存/更新"| E[events テーブル]
    E -->|"5. 保存/更新結果応答"| D
    D -->|"6. 成功応答"| C
    C -->|"7. 成功応答"| B
    B -->|"8. 登録/更新完了通知"| A

    D -->|"9. イベント画像アップロードリクエスト"| F[オブジェクトストレージ/S3]
    F -->|"10. 画像URL応答"| D

\`\`\`

* 処理内容
  * 運営者やアーティストは管理画面を通じてイベント情報を入力します。API Gatewayを経由してイベントサービスにリクエストが送信され、必要に応じて画像はS3へアップロードされます。
  * イベント情報はeventsテーブルに保存または更新されます。

データストア定義
| テーブル名 | 項目名 |
| -- | -- |
| `events` | event\_id, artist\_id, event\_name, description, start\_datetime, end\_datetime, location, ticket\_url, event\_image\_url, status, created\_at, updated\_at |
| AWS S3   | イベント画像ファイル（event\_image\_url）                                       |

### 3.4. イベント情報閲覧・検索フロー（ユーザー）
データフロー図
\`\`\`mermaid
graph TD
    A[ユーザー] -->|1. イベント一覧/検索リクエスト| B(Webアプリケーション)
    B -->|2. APIリクエスト| C(API Gateway)
    C -->|3. イベント情報検索リクエスト| D(イベントサービス)
    D -->|4. イベント情報検索| E[events テーブル]
    D -->|5. 関連タグ情報検索| F[event_tags テーブル]
    D -->|6. タグリレーション検索| G[event_tag_relations テーブル]
    E -->|7. 検索結果応答| D
    F -->|8. 検索結果応答| D
    G -->|9. 検索結果応答| D
    D -->|10. イベント情報/タグ情報応答| C
    C -->|11. 応答| B
    B -->|12. イベント一覧/検索結果表示| A
\`\`\`

処理内容
ユーザーはイベント一覧やキーワード検索をリクエストし、eventsテーブルとタグ情報（event_tags, event_tag_relations）を参照して結果が表示されます。

データストア定義
| テーブル名 | 項目名 |
| -- | -- |
| `events` | 同上 |
| `event_tags` | tag\_id, tag\_name, created\_at, updated\_at |
| `event_tag_relations` | relation\_id, event\_id, tag\_id             |


### 3.5. イベント参加記録・報酬付与フロー
データフロー図
\`\`\`mermaid
graph TD
    A[ユーザー] -->|1. イベント参加登録リクエスト| B(Webアプリケーション)
    B -->|2. APIリクエスト| C(API Gateway)
    C -->|3. イベント参加記録リクエスト| D(イベントサービス)
    D -->|4. 保存| E[event_attendances テーブル]
    E -->|5. 参加記録ID応答| D
    D -->|6. 報酬付与イベント発行| F(メッセージキュー/SQS)
    F -->|7. 成功応答| C
    C -->|8. 成功応答| B
    B -->|9. 参加記録完了通知| A

    F -->|10. イベント取得| G(ワーカープロセス)
    G -->|11. 報酬情報取得| H[rewards テーブル]
    G -->|13. スタンプ付与処理| I[stamps テーブル]
    G -->|14. ポイント付与処理| J[point_histories テーブル]
    G -->|17. ユーザーポイント更新リクエスト| K(ユーザーサービス)
    K -->|18. 更新| L[users テーブル]
    G -->|21. 通知| M(通知サービス)
    M -->|22. ユーザー通知| A
\`\`\`

* 処理内容
  * イベント参加登録後、イベント参加記録を保存し、メッセージキュー（SQS）により報酬処理が非同期で開始されます。
  * 報酬種別によりstampsまたはpoint_historiesテーブルへ保存され、usersテーブルのポイントが更新されます。

データストア定義
| テーブル名 | 項目名  |
| -- | -- |
| `event_attendances` | event\_attendance\_id, user\_id, event\_id, attendance\_timestamp, attendance\_method, verification\_status, notes, created\_at, updated\_at  |
| `rewards` | reward\_id, reward\_type, reward\_name, description, value, created\_at, updated\_at |
| `stamps` | stamp\_id, reward\_id, user\_id, event\_attendance\_id, acquired\_at, stamp\_image\_url, unique\_code |
| `point_histories` | point\_history\_id, reward\_id, user\_id, event\_attendance\_id, points\_change, change\_reason, recorded\_at, current\_points\_after\_change |
| `users` | current\_points |


### 3.6. ポイント利用・履歴閲覧フロー
データフロー図
\`\`\`mermaid
graph TD
    A[ユーザー] -->|1. ポイント残高/履歴リクエスト| B(Webアプリケーション)
    B -->|2. APIリクエスト| C(API Gateway)
    C -->|3. ポイント情報取得リクエスト| D(報酬・ポイントサービス)
    D -->|4. 残高取得| E[users テーブル]
    E -->|5. 履歴取得| F[point_histories テーブル]
    D -->|8. ポイント情報応答| C
    C -->|9. 応答| B
    B -->|10. 表示| A

    A -->|11. ポイント利用リクエスト| B
    B -->|12. APIリクエスト| C
    C -->|13. 利用処理リクエスト| D
    D -->|14. 消費額チェック| E
    E -->|15. 消費処理| J
    J -->|16. 履歴登録| F
    F -->|17. ポイント更新| E
    E -->|19. 応答| K
    K -->|20. 成功応答| D
    D -->|23. 完了通知| A
\`\`\`

* 処理内容
  * ユーザーはポイント残高や履歴を確認できます。また、ポイント利用リクエストが発行されると、残高チェック後、消費と履歴登録が行われ、usersテーブルのポイントが更新されます。

データストア定義

| テーブル名 | 項目名  |
| -- | -- |
| `users` | current\_points |
| `point_histories` | point\_history\_id, reward\_id, user\_id, event\_attendance\_id, points\_change, change\_reason, recorded\_at, current\_points\_after\_change |
